# AI Assistant Instructions

> **For AI Coding Assistants**: This file contains critical rules, project context, and development guidelines. Read and follow these instructions carefully.

## üö´ CRITICAL RULES - READ FIRST

### Release Tag Policy

**‚ö†Ô∏è NEVER create or push version tags (v*) without EXPLICIT user permission in a separate message.**

- Tags trigger automatic production releases to all users
- Releases cannot be easily undone
- Always ask: "Should I create and push the release tag vX.Y.Z now?"
- Wait for clear confirmation before proceeding

**Commands requiring explicit permission:**
- `git tag v*`
- `git push origin v*`
- `git push --follow-tags`
- `gh release create`
- Any command triggering `.github/workflows/release.yml`

**Safe to do without asking:**
- Commit code changes
- Push to main branch (without tags)
- Update CHANGELOG.md
- Update package.json version
- Run builds and tests

See `RELEASE_PROCESS.md` for complete procedures.

---

## Project Overview

A self-contained Electron desktop app wrapping Facebook Messenger (messenger.com) with native OS integrations. Built because Facebook deprecated their official desktop app.

### Tech Stack
- **Electron 28** - Desktop framework
- **TypeScript** - All source code
- **electron-builder** - Packaging and distribution
- **electron-updater** - Auto-updates via GitHub releases

### Repository
- **Owner**: apotenza92
- **Repo**: FacebookMessengerDesktop
- **Main branch**: main
- **Release mechanism**: GitHub Actions triggered by version tags

---

## Project Structure

```
src/
‚îú‚îÄ‚îÄ main/           # Main process (Node.js)
‚îÇ   ‚îú‚îÄ‚îÄ main.ts     # App entry, window management, menus, auto-update
‚îÇ   ‚îú‚îÄ‚îÄ notification-handler.ts
‚îÇ   ‚îú‚îÄ‚îÄ badge-manager.ts
‚îÇ   ‚îî‚îÄ‚îÄ background-service.ts
‚îî‚îÄ‚îÄ preload/        # Preload scripts (bridge between main/renderer)
    ‚îú‚îÄ‚îÄ preload.ts
    ‚îî‚îÄ‚îÄ notifications-inject.ts  # Injected into messenger.com

dist/               # Compiled JS (don't edit directly)
assets/
‚îú‚îÄ‚îÄ icons/          # App icons (all sizes, all platforms)
‚îî‚îÄ‚îÄ tray/           # System tray icons
scripts/            # Build/dev scripts
```

---

## Build Commands

```bash
npm start           # Dev mode (build + run)
npm run build       # Compile TypeScript only
npm run dist        # Build distributable for current platform
npm run dist:mac    # macOS (both architectures)
npm run dist:win    # Windows (both architectures)
npm run dist:linux  # Linux (AppImage, .deb, .rpm, Snap, Flatpak)
```

---

## Development Workflow

### Regular Development (No Permission Needed)

For day-to-day development:

```bash
# Make changes
git add -A
git commit -m "fix: description of changes"
git push origin main
```

This does NOT trigger a release - it just updates the main branch.

### Creating a Release (PERMISSION REQUIRED)

**Step 1: Prepare** (no permission needed)
1. Update `CHANGELOG.md` (newest at top)
   - Format: `## [X.Y.Z] - YYYY-MM-DD`
   - Use plain text, no bold (`**text**`)
2. Update version in `package.json`
3. Commit changes:
   ```bash
   git add -A
   git commit -m "release: prepare vX.Y.Z"
   git push origin main
   ```

**Step 2: Stop and Ask** ‚è∏Ô∏è
- Ask user: "The code is ready for release vX.Y.Z. Should I create and push the release tag now?"
- Wait for explicit confirmation

**Step 3: Create Release** (only after permission)
```bash
# After getting permission:
git tag vX.Y.Z
git push origin vX.Y.Z

# Monitor build
gh run list --workflow=release.yml --limit 1
```

### Version Management Rules

1. **Check latest successful release** before creating new version
2. **Test builds locally first** if making build changes
3. **Only bump version ONCE** - one above last successful release
4. **If build fails**: Fix issue, don't keep bumping versions

**Example**: If v1.1.8 was last successful release:
- Next version should be v1.1.9
- If v1.1.9 build fails, fix the issue and retry v1.1.9
- Don't create v1.1.10 to "try again"

---

## Key Conventions

### Platform-Specific Code

Use `process.platform` checks:
- `'darwin'` - macOS
- `'win32'` - Windows
- `'linux'` - Linux

Pattern used throughout:
```typescript
if (process.platform === 'darwin') {
  // macOS-specific
} else if (process.platform === 'win32') {
  // Windows-specific
} else {
  // Linux/other
}
```

### Menu Structure
- **macOS**: App menu under "Messenger" name (standard macOS convention)
- **Windows/Linux**: Help menu contains app-level items

### Window Behavior
- **macOS**: Close hides to dock
- **Windows/Linux**: Close minimizes to system tray (if tray enabled)
- `isQuitting` flag controls whether close actually quits

### Auto-Updates
- Uses GitHub releases as update source
- `autoUpdater` from electron-updater
- Manual download approval (not auto-download)
- Supports both "latest" and "beta" channels for beta users

### Package Manager Support
- **Homebrew**: `brew install --cask apotenza92/tap/facebook-messenger-desktop`
- **winget**: `winget install apotenza92.FacebookMessengerDesktop`
- **Snap**: Available for x64 and ARM64
- **Flatpak**: Available for x64 and ARM64

---

## Code Style

- TypeScript strict mode
- Async/await for promises
- Console logging with prefixes: `[Component] message`
- Error handling: catch and log, show user-friendly dialogs for critical errors

---

## Testing Changes

1. Run `npm start` for dev mode
2. Test on target platform (features are platform-specific)
3. For update testing, must build distributable and test with actual releases

---

## Common Tasks

### Adding a Menu Item
Edit `createApplicationMenu()` in `main.ts`. Note platform-specific menu structures.

### Modifying Window Behavior
Check `createWindow()` and window event handlers (`close`, `focus`, etc.) in `main.ts`.

### Changing Notification Behavior
- `notifications-inject.ts` intercepts messenger.com's notifications
- `notification-handler.ts` displays native notifications

### Updating Auto-Updater Logic
- Main logic in `setupAutoUpdater()` and `smartCheckForUpdates()` in `main.ts`
- Channel fetching in `fetchChannelVersion()` and `fetchChannelVersionWithRetry()`
- Always return `null` on failure, never throw (allows graceful degradation)

---

## Commit Message Guidelines

Use proper issue references:
- `#21` anywhere in message ‚Üí creates "mentioned in commit" link
- `fixes #21` or `closes #21` ‚Üí also auto-closes the issue when merged
- Format `(#21)` in parentheses works for references

Examples:
- `fix(macOS): media viewer controls obscured (#21)`
- `fix: resolve title bar overlap - fixes #21` (also auto-closes)

---

## Linux Build Notes

- **Snap**:
  - x64: Built with electron-builder on GitHub Actions
  - ARM64: Uses Snapcraft's "Build from GitHub" service
- **Flatpak**: Builds for both x64 and ARM64
- **Test Linux builds on CI** - local macOS/Windows may lack tools

---

## Emergency Procedures

### If Tag Was Created By Mistake
```bash
# Delete local tag
git tag -d vX.Y.Z

# Delete remote tag
git push origin :refs/tags/vX.Y.Z

# Delete GitHub release (if created)
gh release delete vX.Y.Z --yes
```

### If Release Build Failed
1. Check GitHub Actions logs
2. Fix issues in code
3. Reset version if needed
4. Get permission and recreate tag

---

## Remember

‚úÖ **DO**:
- Commit and push code changes freely
- Update documentation
- Run tests
- Ask before creating releases

üö´ **DON'T**:
- Create version tags without permission
- Push tags without confirmation
- Keep bumping versions to fix build issues
- Skip testing on target platforms

---

## Additional Resources

- `RELEASE_PROCESS.md` - Complete release procedures
- `CHANGELOG.md` - Version history
- `.github/workflows/release.yml` - Release automation

---

*Last updated: 2026-01-13*
