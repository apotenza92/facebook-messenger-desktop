name: Build and Release

permissions:
  contents: write
  actions: read

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual triggering

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        include:
          - os: macos-latest
            platform: mac
            artifact_name: mac
            name: macOS
          - os: windows-latest
            platform: win
            artifact_name: windows
            name: Windows
          - os: ubuntu-latest
            platform: linux
            artifact_name: linux
            name: Linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 10

      - name: Install Linux build tools (Snap & Flatpak)
        if: matrix.platform == 'linux'
        run: |
          # Install snapcraft via snap (not apt)
          sudo snap install snapcraft --classic
          # Install flatpak and flatpak-builder
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          # Add flathub remote and install runtime
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build
        timeout-minutes: 5

      - name: Build distributables (mac signed/notarized)
        if: matrix.platform == 'mac'
        run: npm run dist:${{ matrix.platform }}
        timeout-minutes: 30
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: Build distributables (Windows/Linux)
        if: matrix.platform != 'mac'
        run: npm run dist:${{ matrix.platform }}
        timeout-minutes: 45

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-build
          path: |
            release/*.zip
            release/*.exe
            release/*.AppImage
            release/*.deb
            release/*.rpm
            release/*.snap
            release/*.flatpak
            release/*.yml
            release/*.blockmap
          retention-days: 30
          if-no-files-found: error

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 10

      - name: Install Linux build tools (Snap & Flatpak)
        run: |
          # Install LXD for Snap builds
          sudo snap install lxd
          # Initialize LXD with auto mode
          sudo lxd init --auto --storage-backend=dir
          # Add user to lxd group
          sudo usermod -aG lxd $USER
          # Configure LXD socket permissions (allows access without group membership in same session)
          sudo chmod 666 /var/snap/lxd/common/lxd/unix.socket || true
          # Pre-download LXD base image for ARM64 to avoid network issues in containers
          # Use sg to run with lxd group to access LXD
          sg lxd -c "lxc image copy ubuntu:22.04 local: --alias ubuntu-22.04-arm64 || echo 'Image copy failed, will try during build'" || true
          # Install snapcraft via snap
          sudo snap install snapcraft --classic
          # Install flatpak and flatpak-builder
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          # Add flathub remote and install runtime
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build
        timeout-minutes: 5

      - name: Build distributables (Linux ARM64 - Flatpak only, Snap via remote-build)
        run: |
          npm run build
          # Build Flatpak (Snap ARM64 will be built via snapcraft remote-build job)
          npx electron-builder --linux flatpak --arm64 --publish=never
        timeout-minutes: 45

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64-build
          path: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
            release/*.snap
            release/*.flatpak
          retention-days: 30
          if-no-files-found: error

  build-snap-arm64-remote:
    name: Build Snap ARM64 (Remote Build)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Snapcraft
        run: sudo snap install snapcraft --classic

      - name: Authenticate with Snapcraft
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
        run: |
          if [ -n "$SNAPCRAFT_STORE_CREDENTIALS" ]; then
            echo "$SNAPCRAFT_STORE_CREDENTIALS" | snapcraft login --with -
          else
            echo "Warning: SNAPCRAFT_STORE_CREDENTIALS not set. Remote build may fail."
          fi

      - name: Set version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          # Update snapcraft.yaml with version (git version extraction may not work on branches)
          sed -i "s/^version:.*/version: $VERSION/" snapcraft.yaml || echo "Warning: Could not update version in snapcraft.yaml"

      - name: Remote Build Snap for ARM64
        run: |
          # Build ARM64 snap using snapcraft remote-build
          snapcraft remote-build --build-for=arm64 --launchpad-accept-public-upload || echo "Remote build failed or credentials not configured"
        timeout-minutes: 60

      - name: Download built snap
        if: success()
        run: |
          # Find and download the built snap
          SNAP_FILE=$(find . -name "facebook-messenger-desktop_*_arm64.snap" | head -1)
          if [ -n "$SNAP_FILE" ]; then
            echo "Found snap: $SNAP_FILE"
            mkdir -p release
            cp "$SNAP_FILE" release/
          else
            echo "No ARM64 snap file found after remote build"
          fi

      - name: Upload ARM64 snap artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: snap-arm64-remote-build
          path: release/*.snap
          retention-days: 30
          if-no-files-found: warn

  release:
    needs: [build, build-linux-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: '*-build'
          merge-multiple: true
      
      - name: Download ARM64 snap from remote build
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: 'snap-arm64-remote-build'
          merge-multiple: true
          if-no-files-found: warn

      - name: Extract version from tag
        id: tag_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Prepare release notes
        run: |-
          set -euo pipefail
          VERSION="${{ steps.tag_version.outputs.VERSION }}"
          NOTES=release_notes.txt

          if [ ! -f CHANGELOG.md ]; then
            echo "ERROR: CHANGELOG.md not found"
            exit 1
          fi

          # Extract section for this version (between ## [VERSION] and next ##)
          awk -v ver="$VERSION" '
            /^## \[v?/ { if (found) exit; if ($0 ~ "\\[v?" ver "\\]") found=1; next }
            found { print }
          ' CHANGELOG.md > "$NOTES" || true
          
          if [ ! -s "$NOTES" ]; then
            echo "ERROR: No changelog entry found for version $VERSION"
            echo "Please add an entry to CHANGELOG.md before releasing"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          name: Release v${{ steps.tag_version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: false
          body_path: release_notes.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    
    steps:
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Wait for release assets to be available
        run: sleep 30

      - name: Download release assets and calculate hashes
        id: hashes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Download and hash ARM64
          curl -sL "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v${VERSION}/Messenger-macos-arm64.zip" -o arm64.zip
          ARM64_SHA256=$(shasum -a 256 arm64.zip | cut -d' ' -f1)
          echo "ARM64_SHA256=${ARM64_SHA256}" >> $GITHUB_OUTPUT
          
          # Download and hash x64
          curl -sL "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v${VERSION}/Messenger-macos-x64.zip" -o x64.zip
          X64_SHA256=$(shasum -a 256 x64.zip | cut -d' ' -f1)
          echo "X64_SHA256=${X64_SHA256}" >> $GITHUB_OUTPUT

      - name: Update Homebrew cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARM64_SHA256="${{ steps.hashes.outputs.ARM64_SHA256 }}"
          X64_SHA256="${{ steps.hashes.outputs.X64_SHA256 }}"
          
          # Clone homebrew-tap repo
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/apotenza92/homebrew-tap.git
          cd homebrew-tap
          
          # Update the cask file
          cat > Casks/facebook-messenger-desktop.rb << EOF
          cask "facebook-messenger-desktop" do
            version "${VERSION}"

            on_arm do
              sha256 "${ARM64_SHA256}"
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v#{version}/Messenger-macos-arm64.zip"
            end

            on_intel do
              sha256 "${X64_SHA256}"
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v#{version}/Messenger-macos-x64.zip"
            end

            name "Messenger"
            desc "Desktop client for Facebook Messenger"
            homepage "https://github.com/apotenza92/facebook-messenger-desktop"

            livecheck do
              url :url
              strategy :github_latest
            end

            app "Messenger.app"

            zap trash: [
              "~/Library/Application Support/facebook-messenger-desktop",
              "~/Library/Caches/com.facebook.messenger.desktop",
              "~/Library/Caches/com.facebook.messenger.desktop.ShipIt",
              "~/Library/Preferences/com.facebook.messenger.desktop.plist",
              "~/Library/Saved Application State/com.facebook.messenger.desktop.savedState",
            ]
          end
          EOF
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/facebook-messenger-desktop.rb
          git commit -m "Update facebook-messenger-desktop to v${VERSION}"
          git push

  update-winget:
    needs: release
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    
    steps:
      - name: Submit to WinGet
        uses: vedantmgoyal2009/winget-releaser@v2
        with:
          identifier: apotenza92.FacebookMessengerDesktop
          installers-regex: 'Messenger-windows-setup\.exe$'
          token: ${{ secrets.WINGET_TOKEN }}

  update-snapstore:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    
    steps:
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: artifacts

      - name: Install snapcraft
        run: sudo snap install snapcraft --classic

      - name: Upload to Snap Store
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
        run: |
          # Upload x64 snap
          X64_SNAP=$(find artifacts -name "*x64*.snap" -o -name "*.snap" | grep -v arm64 | head -1)
          if [ -n "$X64_SNAP" ]; then
            echo "Uploading x64 snap: $X64_SNAP to Snap Store..."
            snapcraft upload --release=stable "$X64_SNAP"
          fi
          
          # Upload ARM64 snap (from remote build)
          ARM64_SNAP=$(find artifacts -name "*arm64*.snap" | head -1)
          if [ -n "$ARM64_SNAP" ]; then
            echo "Uploading ARM64 snap: $ARM64_SNAP to Snap Store..."
            snapcraft upload --release=stable "$ARM64_SNAP"
          fi
          
          if [ -z "$X64_SNAP" ] && [ -z "$ARM64_SNAP" ]; then
            echo "Warning: No snap files found! Continuing anyway..."
          fi

  update-flatpak-repo:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: artifacts

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder ostree

      - name: Import GPG key
        env:
          FLATPAK_GPG_PRIVATE_KEY: ${{ secrets.FLATPAK_GPG_PRIVATE_KEY }}
        run: |
          echo "$FLATPAK_GPG_PRIVATE_KEY" | base64 -d | gpg --import
          # Get the key ID for signing
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV

      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages || git checkout --orphan gh-pages
          git worktree add gh-pages-worktree gh-pages || mkdir -p gh-pages-worktree
          mkdir -p gh-pages-worktree/flatpak/repo

      - name: Build Flatpak repository
        run: |
          # Find the flatpak bundle
          FLATPAK_FILE=$(find artifacts -name "*.flatpak" | head -1)
          if [ -z "$FLATPAK_FILE" ]; then
            echo "No flatpak file found!"
            exit 1
          fi
          echo "Found flatpak: $FLATPAK_FILE"
          
          # Initialize OSTree repo if it doesn't exist
          REPO_PATH="gh-pages-worktree/flatpak/repo"
          if [ ! -d "$REPO_PATH/objects" ]; then
            echo "Initializing new OSTree repository..."
            ostree init --repo="$REPO_PATH" --mode=archive-z2
          fi
          
          # Import the flatpak bundle into the repository
          echo "Importing flatpak bundle to repository..."
          flatpak build-import-bundle "$REPO_PATH" "$FLATPAK_FILE" --gpg-sign="$GPG_KEY_ID"
          
          # Update repository metadata and sign
          echo "Updating repository metadata..."
          flatpak build-update-repo "$REPO_PATH" --gpg-sign="$GPG_KEY_ID" --generate-static-deltas
          
          # Export public GPG key for users
          gpg --armor --export "$GPG_KEY_ID" > gh-pages-worktree/flatpak/repo/flatpak-repo.gpg
          
          echo "Repository updated successfully"

      - name: Deploy to GitHub Pages
        run: |
          cd gh-pages-worktree
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update Flatpak repository to v${{ steps.version.outputs.VERSION }}" || echo "No changes to commit"
          git push origin gh-pages
