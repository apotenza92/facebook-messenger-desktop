name: Build and Release

permissions:
  contents: write
  actions: read

on:
  push:
    tags:
      - "v*" # Triggers on version tags like v1.0.0
  workflow_dispatch: # Allows manual triggering

jobs:
  # ============================================
  # PHASE 1: Build all platforms
  # ============================================

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 10

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build
        timeout-minutes: 5

      - name: Build distributables (signed/notarized)
        run: npm run dist:mac
        timeout-minutes: 30
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: Backup stable yml files before beta build
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        run: |
          # Save stable yml files before beta build overwrites them
          mkdir -p release/stable-yml-backup
          cp release/*.yml release/stable-yml-backup/ || true

      - name: Build beta-channel artifacts for stable release (signed/notarized)
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        run: |
          # Run electron-builder directly without npm run build (which cleans the release folder)
          # The TypeScript was already compiled in the previous step
          npx electron-builder --config electron-builder.config.js --mac --arm64 --x64 --publish=never
        timeout-minutes: 30
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          FORCE_BETA_BUILD: "true"

      - name: Restore stable yml files (beta yml already created by electron-builder)
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        run: |
          # The beta build with channel:'beta' creates beta-*.yml files directly
          # We just need to restore the stable latest-*.yml files from backup
          cp release/stable-yml-backup/latest*.yml release/ || true
          rm -rf release/stable-yml-backup
          echo "YML files in release folder:"
          ls -la release/*.yml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            release/*.zip
            release/*.yml
            release/*.blockmap
          retention-days: 30
          if-no-files-found: error

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 10

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build
        timeout-minutes: 5

      - name: Build distributables
        run: npm run dist:win
        timeout-minutes: 30

      - name: Backup stable yml files before beta build
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        shell: pwsh
        run: |
          # Save stable yml files before beta build overwrites them
          New-Item -ItemType Directory -Force -Path release/stable-yml-backup | Out-Null
          Copy-Item release/*.yml release/stable-yml-backup/ -ErrorAction SilentlyContinue

      - name: Build beta-channel artifacts for stable release
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        run: npx electron-builder --config electron-builder.config.js --win --publish=never
        timeout-minutes: 30
        env:
          FORCE_BETA_BUILD: "true"

      - name: Restore stable yml files (beta yml already created by electron-builder)
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        shell: pwsh
        run: |
          # The beta build with channel:'beta' creates beta-*.yml files directly
          # We just need to restore the stable latest-*.yml files from backup
          Copy-Item release/stable-yml-backup/latest*.yml release/ -Force -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force release/stable-yml-backup -ErrorAction SilentlyContinue
          Write-Host "YML files in release folder:"
          Get-ChildItem release/*.yml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            release/*.exe
            release/*.yml
            release/*.blockmap
          retention-days: 30
          if-no-files-found: error

  # Linux builds (AppImage, deb, rpm, flatpak) for both x64 and ARM64
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 10

      - name: Install Flatpak tools and runtimes
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          # Add Flathub for runtimes (needed by electron-builder)
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          # Install required runtimes for Flatpak build
          sudo flatpak install -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08 org.electronjs.Electron2.BaseApp//24.08

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build
        timeout-minutes: 5

      - name: Build distributables
        run: npm run dist:linux
        timeout-minutes: 60

      - name: Backup stable yml files before beta build
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        run: |
          # Save stable yml files before beta build overwrites them
          mkdir -p release/stable-yml-backup
          cp release/*.yml release/stable-yml-backup/ || true

      - name: Build beta-channel artifacts for stable release
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        run: |
          # Run electron-builder directly without npm run build (which cleans the release folder)
          # The TypeScript was already compiled in the previous step
          npx electron-builder --config electron-builder.config.js --linux --publish=never
        timeout-minutes: 60
        env:
          FORCE_BETA_BUILD: "true"

      - name: Restore stable yml files (beta yml already created by electron-builder)
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        run: |
          # The beta build with channel:'beta' creates beta-*.yml files directly
          # We just need to restore the stable latest-*.yml files from backup
          cp release/stable-yml-backup/latest*.yml release/ || true
          rm -rf release/stable-yml-backup
          echo "YML files in release folder:"
          ls -la release/*.yml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
            release/*.flatpak
            release/*.yml
          retention-days: 30
          if-no-files-found: error

  # NOTE: All Snap builds (amd64 and arm64) are handled by Snapcraft's "Build from GitHub" service
  # which automatically builds snaps when you push to the repo.
  # See: https://snapcraft.io/facebook-messenger-desktop/builds

  # ============================================
  # PHASE 2: Create GitHub Release
  # (Runs after all builds complete)
  # ============================================

  release:
    name: Create Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-build"
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "Artifacts from CI builds:"
          find artifacts -type f | sort || echo "No CI artifacts found"

      - name: Extract version from tag
        id: tag_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Prepare release notes
        run: |-
          set -euo pipefail
          VERSION="${{ steps.tag_version.outputs.VERSION }}"
          NOTES=release_notes.txt

          if [ ! -f CHANGELOG.md ]; then
            echo "ERROR: CHANGELOG.md not found"
            exit 1
          fi

          # Extract section for this version (between ## [VERSION] and next ##)
          # Escape special regex characters in version string
          ESCAPED_VER=$(echo "$VERSION" | sed 's/\./\\./g; s/-/\\-/g')
          awk -v ver="$ESCAPED_VER" '
            /^## \[v?/ { if (found) exit; if ($0 ~ "\\[v?" ver "\\]") found=1; next }
            found { print }
          ' CHANGELOG.md > "$NOTES" || true

          if [ ! -s "$NOTES" ]; then
            echo "ERROR: No changelog entry found for version $VERSION"
            echo "Please add an entry to CHANGELOG.md before releasing"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          name: Release v${{ steps.tag_version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: false
          body_path: release_notes.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # PHASE 3: Update package managers
  # (Runs after release is created)
  # ============================================

  update-homebrew:
    name: Update Homebrew (Stable)
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')

    steps:
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Wait for release assets to be available
        run: sleep 30

      - name: Download release assets and calculate hashes
        id: hashes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Download and hash ARM64 (stable)
          curl -sL "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v${VERSION}/Messenger-macos-arm64.zip" -o arm64.zip
          ARM64_SHA256=$(shasum -a 256 arm64.zip | cut -d' ' -f1)
          echo "ARM64_SHA256=${ARM64_SHA256}" >> $GITHUB_OUTPUT

          # Download and hash x64 (stable)
          curl -sL "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v${VERSION}/Messenger-macos-x64.zip" -o x64.zip
          X64_SHA256=$(shasum -a 256 x64.zip | cut -d' ' -f1)
          echo "X64_SHA256=${X64_SHA256}" >> $GITHUB_OUTPUT

          # Download and hash ARM64 (beta-branded artifacts for beta cask)
          curl -sL "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v${VERSION}/Messenger-Beta-macos-arm64.zip" -o arm64-beta.zip
          ARM64_BETA_SHA256=$(shasum -a 256 arm64-beta.zip | cut -d' ' -f1)
          echo "ARM64_BETA_SHA256=${ARM64_BETA_SHA256}" >> $GITHUB_OUTPUT

          # Download and hash x64 (beta-branded artifacts for beta cask)
          curl -sL "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v${VERSION}/Messenger-Beta-macos-x64.zip" -o x64-beta.zip
          X64_BETA_SHA256=$(shasum -a 256 x64-beta.zip | cut -d' ' -f1)
          echo "X64_BETA_SHA256=${X64_BETA_SHA256}" >> $GITHUB_OUTPUT

      - name: Update Homebrew casks (stable and beta)
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARM64_SHA256="${{ steps.hashes.outputs.ARM64_SHA256 }}"
          X64_SHA256="${{ steps.hashes.outputs.X64_SHA256 }}"
          ARM64_BETA_SHA256="${{ steps.hashes.outputs.ARM64_BETA_SHA256 }}"
          X64_BETA_SHA256="${{ steps.hashes.outputs.X64_BETA_SHA256 }}"

          # Clone homebrew-tap repo
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/apotenza92/homebrew-tap.git
          cd homebrew-tap

          # Update the stable cask file
          cat > Casks/facebook-messenger-desktop.rb << EOF
          cask "facebook-messenger-desktop" do
            version "${VERSION}"

            on_arm do
              sha256 "${ARM64_SHA256}"
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v#{version}/Messenger-macos-arm64.zip"
            end

            on_intel do
              sha256 "${X64_SHA256}"
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v#{version}/Messenger-macos-x64.zip"
            end

            name "Messenger"
            desc "Desktop client for Facebook Messenger"
            homepage "https://github.com/apotenza92/facebook-messenger-desktop"

            livecheck do
              url :url
              strategy :github_latest
            end

            app "Messenger.app"

            zap trash: [
              "~/Library/Application Support/Messenger",
              "~/Library/Caches/com.facebook.messenger.desktop",
              "~/Library/Caches/com.facebook.messenger.desktop.ShipIt",
              "~/Library/Preferences/com.facebook.messenger.desktop.plist",
              "~/Library/Saved Application State/com.facebook.messenger.desktop.savedState",
            ]
          end
          EOF

          # Also update the beta cask to point to beta-branded artifacts of this stable release
          # This ensures beta users get updates when stable releases come out
          cat > 'Casks/facebook-messenger-desktop@beta.rb' << EOF
          cask "facebook-messenger-desktop@beta" do
            version "${VERSION}"

            on_arm do
              sha256 "${ARM64_BETA_SHA256}"
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v#{version}/Messenger-Beta-macos-arm64.zip"
            end

            on_intel do
              sha256 "${X64_BETA_SHA256}"
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v#{version}/Messenger-Beta-macos-x64.zip"
            end

            name "Messenger Beta"
            desc "Desktop client for Facebook Messenger (Beta)"
            homepage "https://github.com/apotenza92/facebook-messenger-desktop"

            livecheck do
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases"
              regex(/v?(\d+(?:\.\d+)*(?:-(?:alpha|beta|rc)[\w.]*)?)/i)
              strategy :page_match
            end

            app "Messenger Beta.app"

            zap trash: [
              "~/Library/Application Support/Messenger-Beta",
              "~/Library/Caches/com.facebook.messenger.desktop.beta",
              "~/Library/Caches/com.facebook.messenger.desktop.beta.ShipIt",
              "~/Library/Preferences/com.facebook.messenger.desktop.beta.plist",
              "~/Library/Saved Application State/com.facebook.messenger.desktop.beta.savedState",
            ]
          end
          EOF

          # Commit and push both cask updates
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/facebook-messenger-desktop.rb 'Casks/facebook-messenger-desktop@beta.rb'
          git commit -m "Update facebook-messenger-desktop to v${VERSION} (stable + beta casks)"
          git push

  update-homebrew-beta:
    name: Update Homebrew (Beta)
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && (contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc'))

    steps:
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Wait for release assets to be available
        run: sleep 30

      - name: Download release assets and calculate hashes
        id: hashes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Download and hash ARM64 (beta artifacts have different names)
          curl -sL "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v${VERSION}/Messenger-Beta-macos-arm64.zip" -o arm64.zip
          ARM64_SHA256=$(shasum -a 256 arm64.zip | cut -d' ' -f1)
          echo "ARM64_SHA256=${ARM64_SHA256}" >> $GITHUB_OUTPUT

          # Download and hash x64
          curl -sL "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v${VERSION}/Messenger-Beta-macos-x64.zip" -o x64.zip
          X64_SHA256=$(shasum -a 256 x64.zip | cut -d' ' -f1)
          echo "X64_SHA256=${X64_SHA256}" >> $GITHUB_OUTPUT

      - name: Update Homebrew beta cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARM64_SHA256="${{ steps.hashes.outputs.ARM64_SHA256 }}"
          X64_SHA256="${{ steps.hashes.outputs.X64_SHA256 }}"

          # Clone homebrew-tap repo
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/apotenza92/homebrew-tap.git
          cd homebrew-tap

          # Update the beta cask file (versioned cask style: name@beta)
          cat > 'Casks/facebook-messenger-desktop@beta.rb' << EOF
          cask "facebook-messenger-desktop@beta" do
            version "${VERSION}"

            on_arm do
              sha256 "${ARM64_SHA256}"
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v#{version}/Messenger-Beta-macos-arm64.zip"
            end

            on_intel do
              sha256 "${X64_SHA256}"
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases/download/v#{version}/Messenger-Beta-macos-x64.zip"
            end

            name "Messenger Beta"
            desc "Desktop client for Facebook Messenger (Beta)"
            homepage "https://github.com/apotenza92/facebook-messenger-desktop"

            livecheck do
              url "https://github.com/apotenza92/facebook-messenger-desktop/releases"
              regex(/v?(\d+(?:\.\d+)*-(?:alpha|beta|rc)[\w.]*)/i)
              strategy :page_match
            end

            app "Messenger Beta.app"

            zap trash: [
              "~/Library/Application Support/Messenger-Beta",
              "~/Library/Caches/com.facebook.messenger.desktop.beta",
              "~/Library/Caches/com.facebook.messenger.desktop.beta.ShipIt",
              "~/Library/Preferences/com.facebook.messenger.desktop.beta.plist",
              "~/Library/Saved Application State/com.facebook.messenger.desktop.beta.savedState",
            ]
          end
          EOF

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add 'Casks/facebook-messenger-desktop@beta.rb'
          git commit -m "Update facebook-messenger-desktop@beta to v${VERSION}"
          git push

  update-winget:
    name: Update WinGet
    needs: release
    runs-on: windows-latest
    if: false # Disabled - no winget package yet
    # Original condition: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    continue-on-error: true # Don't fail the workflow if winget update fails

    steps:
      - name: Submit to WinGet
        uses: vedantmgoyal2009/winget-releaser@v2
        with:
          identifier: apotenza92.FacebookMessengerDesktop
          installers-regex: 'Messenger-windows-x64-setup\.exe$'
          token: ${{ secrets.WINGET_TOKEN }}

  # NOTE: Snap promotion is handled by snap-promote.yml workflow (runs every 6 hours)
  # Launchpad builds snaps automatically, then snap-promote.yml promotes edge to beta/stable

  update-flatpak-repo:
    name: Update Flatpak Repo
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    continue-on-error: true # Don't fail the workflow if flatpak update fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: artifacts/linux

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder ostree

      - name: Import GPG key
        env:
          FLATPAK_GPG_PRIVATE_KEY: ${{ secrets.FLATPAK_GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$FLATPAK_GPG_PRIVATE_KEY" ]; then
            echo "ERROR: FLATPAK_GPG_PRIVATE_KEY secret not set"
            echo "To fix: Generate a GPG key, export it with 'gpg --export-secret-keys KEY_ID | base64', and add as secret"
            exit 1
          fi
          # Try to decode and import the GPG key
          echo "$FLATPAK_GPG_PRIVATE_KEY" | base64 -d | gpg --import || {
            echo "ERROR: Failed to import GPG key. The FLATPAK_GPG_PRIVATE_KEY secret may be incorrectly encoded."
            echo "To fix: Export your GPG key with 'gpg --export-secret-keys KEY_ID | base64 -w 0' and update the secret"
            exit 1
          }
          # Get the key ID for signing
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
          if [ -z "$GPG_KEY_ID" ]; then
            echo "ERROR: Failed to get GPG key ID after import"
            exit 1
          fi
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV
          echo "Successfully imported GPG key: $GPG_KEY_ID"

      - name: Build Flatpak repository
        run: |
          # Create a temporary directory for the OSTree repo
          mkdir -p flatpak-repo
          REPO_PATH="flatpak-repo"

          # Initialize OSTree repo
          echo "Initializing OSTree repository..."
          ostree init --repo="$REPO_PATH" --mode=archive-z2

          # List available flatpak files for debugging
          echo "Available flatpak files:"
          find artifacts/linux -name "*.flatpak" -type f || echo "No flatpak files found"

          # Import x64 flatpak (electron-builder uses 'x86_64' in flatpak filename)
          X64_FLATPAK=$(find artifacts/linux -name "*x86_64*.flatpak" -type f | head -1)
          if [ -n "$X64_FLATPAK" ]; then
            echo "Importing x64 flatpak: $X64_FLATPAK"
            flatpak build-import-bundle "$REPO_PATH" "$X64_FLATPAK" --gpg-sign="$GPG_KEY_ID"
          fi

          # Import ARM64 flatpak (electron-builder uses 'aarch64' in flatpak filename)
          ARM64_FLATPAK=$(find artifacts/linux -name "*aarch64*.flatpak" -type f | head -1)
          if [ -n "$ARM64_FLATPAK" ]; then
            echo "Importing ARM64 flatpak: $ARM64_FLATPAK"
            flatpak build-import-bundle "$REPO_PATH" "$ARM64_FLATPAK" --gpg-sign="$GPG_KEY_ID"
          fi

          if [ -z "$X64_FLATPAK" ] && [ -z "$ARM64_FLATPAK" ]; then
            echo "⚠️ No flatpak files found in artifacts - skipping repo update"
            echo "To enable: add 'flatpak' target to package.json linux.target array"
            exit 0
          fi

          # Update repository metadata and sign
          echo "Updating repository metadata..."
          flatpak build-update-repo "$REPO_PATH" --gpg-sign="$GPG_KEY_ID" --generate-static-deltas

          # Export public GPG key for users
          gpg --armor --export "$GPG_KEY_ID" > flatpak-repo/flatpak-repo.gpg

          echo "Repository built successfully"

      - name: Deploy to GitHub Pages
        run: |
          # Clone main branch to update the docs folder
          git clone --single-branch --branch main "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" main-deploy

          # Copy flatpak repo to docs/flatpak/repo (GitHub Pages serves from docs/ on main)
          mkdir -p main-deploy/docs/flatpak
          rm -rf main-deploy/docs/flatpak/repo
          cp -r flatpak-repo main-deploy/docs/flatpak/repo

          # Commit and push
          cd main-deploy
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/flatpak/
          git commit -m "Update Flatpak repository to v${{ steps.version.outputs.VERSION }}" || echo "No changes to commit"
          git push origin main
