name: Test Snap ARM64 Build

permissions:
  contents: read
  actions: read

on:
  push:
    branches:
      - test-snap-arm64
  workflow_dispatch:

jobs:
  build-linux-arm64:
    name: Test Linux ARM64 Build (Snap & Flatpak)
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 10

      - name: Install Linux build tools (Snap & Flatpak)
        run: |
          # Install LXD for Snap builds
          sudo snap install lxd
          # Initialize LXD with auto mode
          sudo lxd init --auto --storage-backend=dir
          # Add user to lxd group
          sudo usermod -aG lxd $USER
          # Configure LXD socket permissions (allows access without group membership in same session)
          sudo chmod 666 /var/snap/lxd/common/lxd/unix.socket || true
          # Install snapcraft via snap
          sudo snap install snapcraft --classic
          # Install flatpak and flatpak-builder
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          # Add flathub remote and install runtime
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Generate icons
        run: npm run generate-icons

      - name: Build application
        run: npm run build
        timeout-minutes: 5

      - name: Build distributables (Linux ARM64 - Snap and Flatpak)
        run: |
          npm run build
          # Use sg to run with lxd group, or use newgrp in a subshell
          # Try snap first, fallback to flatpak only if snap fails
          sg lxd -c "npx electron-builder --linux snap flatpak --arm64 --publish=never" || npx electron-builder --linux flatpak --arm64 --publish=never
        timeout-minutes: 45

      - name: List built artifacts
        run: |
          echo "Built artifacts:"
          ls -lh release/ || echo "No release directory found"
          find release -name "*.snap" -o -name "*.flatpak" || echo "No snap or flatpak files found"

      - name: Verify Snap file
        run: |
          SNAP_FILE=$(find release -name "*arm64*.snap" | head -1)
          if [ -z "$SNAP_FILE" ]; then
            echo "WARNING: No ARM64 snap file found (this is expected if snap build failed)"
          else
            echo "SUCCESS: Found ARM64 snap: $SNAP_FILE"
            file "$SNAP_FILE"
            ls -lh "$SNAP_FILE"
          fi

      - name: Verify Flatpak file
        run: |
          FLATPAK_FILE=$(find release -name "*arm64*.flatpak" | head -1)
          if [ -z "$FLATPAK_FILE" ]; then
            echo "ERROR: No ARM64 flatpak file found!"
            exit 1
          fi
          echo "SUCCESS: Found ARM64 flatpak: $FLATPAK_FILE"
          file "$FLATPAK_FILE"
          ls -lh "$FLATPAK_FILE"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-snap-arm64-builds
          path: |
            release/*.snap
            release/*.flatpak
          retention-days: 7
          if-no-files-found: warn

